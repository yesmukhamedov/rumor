<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Graph View</title>
    <link rel="stylesheet" href="https://unpkg.com/vis-network/styles/vis-network.min.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .layout { display: flex; gap: 1.5rem; align-items: flex-start; }
        #network { flex: 1; height: 80vh; border: 1px solid #ddd; }
        .taskbar { width: 300px; border: 1px solid #ddd; padding: 1rem; border-radius: 4px; }
        .taskbar h2 { margin-top: 0; }
        .taskbar section + section { margin-top: 1.5rem; }
        .taskbar .panel-title { display: flex; align-items: baseline; justify-content: space-between; }
        .taskbar ul { list-style: none; padding-left: 0; margin: 0; }
        .taskbar li { padding: 0.5rem 0; border-bottom: 1px solid #eee; }
        .taskbar li:last-child { border-bottom: none; }
        .taskbar .meta { color: #666; font-size: 0.85rem; }
    </style>
</head>
<body>
<div class="container">
    <h1>Graph View</h1>
    <p>
        <a th:href="@{/admin/nodes}">Admin</a>
    </p>
    <div class="layout">
        <div id="network"></div>
        <aside class="taskbar">
            <section>
                <div class="panel-title">
                    <h2>Connections</h2>
                    <span class="meta" id="selectedNodeName">Selected node: none</span>
                </div>
                <div id="connectionsPanel">
                    <p class="meta">Click a node to see its connections.</p>
                </div>
            </section>
            <section>
                <div class="panel-title">
                    <h2>Private relations</h2>
                </div>
                <div id="privateRelationsPanel">
                    <p class="meta">Click a node to see its private relations.</p>
                </div>
            </section>
            <section>
                <div class="panel-title">
                    <h2>Public relations</h2>
                    <button type="button" id="clearPublicFilter">Clear</button>
                </div>
                <label for="publicAt">At time</label>
                <input id="publicAt" type="datetime-local" />
                <p th:if="${#lists.isEmpty(publicEdges)}">No public relations yet.</p>
                <ul th:if="${!#lists.isEmpty(publicEdges)}" id="publicEdgesList">
                    <li th:each="edge : ${publicEdges}"
                        th:attr="data-created=${edge.createdAt != null ? #temporals.format(edge.createdAt, 'yyyy-MM-dd''T''HH:mm') : ''},
                                 data-expired=${edge.expiredAt != null ? #temporals.format(edge.expiredAt, 'yyyy-MM-dd''T''HH:mm') : ''}">
                        <div>
                            <strong th:text="${edge.label != null ? edge.label : '(unnamed relation)'}"></strong>
                            <span> → </span>
                            <span th:text="${edge.toName}"></span>
                        </div>
                        <div class="meta">
                            <span th:if="${edge.createdAt != null}" th:text="|Created: ${edge.createdAt}|"></span>
                            <span th:if="${edge.createdAt != null && edge.expiredAt != null}"> · </span>
                            <span th:if="${edge.expiredAt != null}" th:text="|Expired: ${edge.expiredAt}|"></span>
                        </div>
                    </li>
                </ul>
            </section>
        </aside>
    </div>
</div>

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script th:inline="javascript">
    const nodes = /*[[${nodes}]]*/ [];
    const edges = /*[[${edges}]]*/ [];
    const publicEdges = /*[[${publicEdges}]]*/ [];

    const nodesData = nodes.map(node => ({
        id: node.id,
        label: node.name
    }));

    const normalEdges = edges.filter(edge => edge.relation);
    const privateEdges = edges.filter(edge => edge.note);

    const edgesData = normalEdges.map(edge => ({
        from: edge.fromId,
        to: edge.toId,
        label: edge.label ? edge.label : "",
        arrows: "to"
    }));

    const container = document.getElementById("network");
    const data = {
        nodes: new vis.DataSet(nodesData),
        edges: new vis.DataSet(edgesData)
    };
    const options = {
        layout: {
            improvedLayout: true
        },
        physics: {
            stabilization: true
        }
    };

    const nodeNameById = new Map(nodes.map(node => [node.id, node.name]));
    const network = new vis.Network(container, data, options);

    const selectedNodeName = document.getElementById("selectedNodeName");
    const connectionsPanel = document.getElementById("connectionsPanel");
    const privateRelationsPanel = document.getElementById("privateRelationsPanel");

    function renderConnections(selectedId) {
        if (!selectedId) {
            selectedNodeName.textContent = "Selected node: none";
            connectionsPanel.innerHTML = "<p class=\"meta\">Click a node to see its connections.</p>";
            return;
        }
        const selectedName = nodeNameById.get(selectedId) || "Unknown";
        selectedNodeName.textContent = `Selected node: ${selectedName}`;

        const outgoing = normalEdges
            .filter(edge => edge.fromId === selectedId)
            .map(edge => nodeNameById.get(edge.toId) || `Node ${edge.toId}`);
        const incoming = normalEdges
            .filter(edge => edge.toId === selectedId)
            .map(edge => nodeNameById.get(edge.fromId) || `Node ${edge.fromId}`);

        if (outgoing.length === 0 && incoming.length === 0) {
            connectionsPanel.innerHTML = "<p class=\"meta\">No connections.</p>";
            return;
        }

        const outgoingItems = outgoing.map(name => `<li>→ ${name}</li>`).join("");
        const incomingItems = incoming.map(name => `<li>← ${name}</li>`).join("");
        connectionsPanel.innerHTML = `
            ${outgoing.length ? `<h3>Outgoing</h3><ul>${outgoingItems}</ul>` : ""}
            ${incoming.length ? `<h3>Incoming</h3><ul>${incomingItems}</ul>` : ""}
        `;
    }

    function renderPrivateRelations(selectedId) {
        if (!selectedId) {
            privateRelationsPanel.innerHTML = "<p class=\"meta\">Click a node to see its private relations.</p>";
            return;
        }

        const relations = privateEdges.filter(edge => edge.fromId === selectedId);
        if (relations.length === 0) {
            privateRelationsPanel.innerHTML = "<p class=\"meta\">No private relations.</p>";
            return;
        }

        const items = relations.map(edge => {
            const label = edge.label ? edge.label : "—";
            const createdAt = edge.createdAt ? `Created: ${edge.createdAt}` : "";
            const expiredAt = edge.expiredAt ? `Expired: ${edge.expiredAt}` : "";
            const meta = [createdAt, expiredAt].filter(Boolean).join(" · ");
            return `
                <li>
                    <div><strong>${label}</strong></div>
                    ${meta ? `<div class="meta">${meta}</div>` : ""}
                </li>
            `;
        }).join("");
        privateRelationsPanel.innerHTML = `<ul>${items}</ul>`;
    }

    network.on("click", function (params) {
        if (params.nodes && params.nodes.length > 0) {
            const nodeId = params.nodes[0];
            renderConnections(nodeId);
            renderPrivateRelations(nodeId);
        }
    });

    const publicAtInput = document.getElementById("publicAt");
    const clearPublicFilter = document.getElementById("clearPublicFilter");
    const publicEdgesList = document.getElementById("publicEdgesList");

    function filterPublicEdges() {
        if (!publicEdgesList) {
            return;
        }
        const value = publicAtInput.value;
        const selectedTime = value ? new Date(value) : null;
        const items = publicEdgesList.querySelectorAll("li");
        items.forEach(item => {
            if (!selectedTime) {
                item.style.display = "";
                return;
            }
            const createdValue = item.dataset.created;
            const expiredValue = item.dataset.expired;
            const createdAt = createdValue ? new Date(createdValue) : null;
            const expiredAt = expiredValue ? new Date(expiredValue) : null;
            const isActive = (!createdAt || createdAt <= selectedTime)
                && (!expiredAt || selectedTime <= expiredAt);
            item.style.display = isActive ? "" : "none";
        });
    }

    if (publicAtInput) {
        publicAtInput.addEventListener("change", filterPublicEdges);
    }
    if (clearPublicFilter) {
        clearPublicFilter.addEventListener("click", () => {
            publicAtInput.value = "";
            filterPublicEdges();
        });
    }
</script>
</body>
</html>
