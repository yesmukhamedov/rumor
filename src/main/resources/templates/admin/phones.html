<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Phones Admin</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        nav a { margin-right: 1rem; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 2rem; }
        th, td { border: 1px solid #ddd; padding: 0.5rem; }
        th { background-color: #f5f5f5; text-align: left; }
        .message { padding: 0.75rem; margin-bottom: 1rem; border-radius: 4px; }
        .message.success { background-color: #e7f6e7; color: #1e5c1e; }
        .message.error { background-color: #fdecea; color: #9b1c1c; }
        form.inline { display: inline; }
        .form-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1rem; }
        .form-row label { min-width: 120px; }
        .form-row input, .form-row select { min-width: 180px; }
    </style>
</head>
<body>
<header>
    <h1>Phones Admin</h1>
    <nav>
        <a th:href="@{/admin/nodes}">Nodes</a>
        <a th:href="@{/admin/edges}">Edges</a>
        <a th:href="@{/admin/phones}">Phones</a>
        <a th:href="@{/graph/view}">Graph View</a>
        <form th:action="@{/logout}" method="post" class="inline">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit">Logout</button>
        </form>
    </nav>
</header>

<div th:if="${success}" class="message success" th:text="${success}"></div>
<div th:if="${error}" class="message error" th:text="${error}"></div>

<section>
    <h2>Create Phone</h2>
    <form th:action="@{/admin/phones}" method="post" th:object="${phoneForm}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="form-row">
            <label for="nodeId">Node</label>
            <select id="nodeId" th:field="*{nodeId}" required>
                <option value="" selected disabled>-- select --</option>
                <option th:each="node : ${availableNodes}"
                        th:value="${node.id}"
                        th:text="${node.name}"></option>
            </select>
            <label for="patternId">Pattern</label>
            <select id="patternId" th:field="*{patternId}" required>
                <option value="" selected disabled>-- select --</option>
                <option th:each="pattern : ${patterns}"
                        th:value="${pattern.id}"
                        th:text="${pattern.code}"
                        th:attr="data-mask=${pattern.value}"></option>
            </select>
            <label for="phoneValue">Phone</label>
            <input id="phoneValue" type="text" maxlength="32" autocomplete="off" required />
            <input id="phoneDigits" type="hidden" th:field="*{digits}" />
            <button type="submit">Create Phone</button>
        </div>
        <div class="form-row">
            <div id="maskHint"></div>
        </div>
    </form>
</section>

<section>
    <h2>Phones</h2>
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Node Name</th>
            <th>Pattern Code</th>
            <th>Value</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:if="${#lists.isEmpty(phones)}">
            <td colspan="5">No phones yet.</td>
        </tr>
        <tr th:each="phone : ${phones}">
            <td th:text="${phone.id}"></td>
            <td th:text="${phone.nodeName}"></td>
            <td th:text="${phone.currentValue.pattern.code}"></td>
            <td th:text="${phone.currentValue.displayValue}"></td>
            <td>
                <form class="inline" th:action="@{/admin/phones/{id}/delete(id=${phone.id})}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit">Delete</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</section>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const patternSelect = document.getElementById('patternId');
        const phoneInput = document.getElementById('phoneValue');
        const maskHint = document.getElementById('maskHint');
        const phoneDigits = document.getElementById('phoneDigits');
        let mask = '';
        let underscorePositions = [];

        function updateUnderscorePositions() {
            underscorePositions = [];
            for (let i = 0; i < mask.length; i++) {
                if (mask[i] === '_') {
                    underscorePositions.push(i);
                }
            }
        }

        function normalizeValue(value) {
            if (!mask) {
                return value;
            }
            const chars = mask.split('');
            for (let i = 0; i < mask.length; i++) {
                if (mask[i] === '_') {
                    chars[i] = /\d/.test(value[i]) ? value[i] : '_';
                }
            }
            return chars.join('');
        }

        function setMask(newMask, preserveInput) {
            mask = newMask || '';
            updateUnderscorePositions();
            phoneInput.maxLength = mask.length || 32;
            if (!preserveInput || !phoneInput.value) {
                phoneInput.value = mask;
            } else {
                phoneInput.value = normalizeValue(phoneInput.value);
            }
            maskHint.textContent = mask ? `Mask: ${mask}` : '';
            updateDigits();
        }

        function fillNextDigit(digit) {
            const current = phoneInput.value;
            const nextIndex = underscorePositions.find((index) => current[index] === '_');
            if (nextIndex === undefined) {
                return;
            }
            const chars = current.split('');
            chars[nextIndex] = digit;
            phoneInput.value = chars.join('');
            updateDigits();
        }

        function removePreviousDigit() {
            const current = phoneInput.value;
            for (let i = underscorePositions.length - 1; i >= 0; i--) {
                const index = underscorePositions[i];
                if (/\d/.test(current[index])) {
                    const chars = current.split('');
                    chars[index] = '_';
                    phoneInput.value = chars.join('');
                    updateDigits();
                    return;
                }
            }
        }

        function getCodeDigits() {
            if (!mask) {
                return '';
            }
            const prefix = mask.split('_')[0];
            return prefix.replace(/\D/g, '');
        }

        function updateDigits() {
            if (!phoneDigits) {
                return;
            }
            let raw = phoneInput.value.replace(/\D/g, '');
            const codeDigits = getCodeDigits();
            if (codeDigits && raw.startsWith(codeDigits)) {
                raw = raw.slice(codeDigits.length);
            }
            phoneDigits.value = raw;
        }

        patternSelect.addEventListener('change', function () {
            const selected = patternSelect.options[patternSelect.selectedIndex];
            setMask(selected ? selected.dataset.mask : '', false);
        });

        phoneInput.addEventListener('input', updateDigits);

        phoneInput.addEventListener('keydown', function (event) {
            if (!mask) {
                return;
            }
            if (event.ctrlKey || event.metaKey) {
                return;
            }
            if (event.key === 'Backspace' || event.key === 'Delete') {
                event.preventDefault();
                removePreviousDigit();
                return;
            }
            if (event.key.length === 1 && /\d/.test(event.key)) {
                event.preventDefault();
                fillNextDigit(event.key);
                return;
            }
            if (['Tab', 'ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(event.key)) {
                return;
            }
            event.preventDefault();
        });

        const initialOption = patternSelect.options[patternSelect.selectedIndex];
        const initialMask = initialOption ? initialOption.dataset.mask : '';
        setMask(initialMask, true);
    });
</script>
</body>
</html>
